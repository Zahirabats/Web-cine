<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Ventas - Movie Pop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  <style>
    body {
      background-color: #f0ff;
      color: #0a1d3a;
      font-family: Arial, sans-serif;
    }
    .navbar { background-color: #0a1d3a; }
    .card-dashboard {
        border: none; border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        transition: transform 0.3s;
    }
    .card-dashboard:hover { transform: translateY(-5px); }
    .icon-box { font-size: 2.5rem; color: #0a1d3a; }
    .table-container {
        background: white; padding: 20px;
        border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .table thead { background-color: #0a1d3a; color: white; }
  </style>
</head>
<body>

  <nav class="navbar navbar-dark p-3">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1 fw-bold"><i class="bi bi-graph-up"></i> MOVIE POP - ADMIN</span>
      <button class="btn btn-outline-light btn-sm" onclick="window.location.href='index.html'">Ir a la Web</button>
    </div>
  </nav>

  <div class="container mt-5">
    <h2 class="mb-4 fw-bold">Resumen de Ventas</h2>
    
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex align-items-center bg-white p-3 rounded shadow-sm">
                <label for="filtroFecha" class="form-label me-3 mb-0 fw-bold">Filtrar por Fecha de Función:</label>
                <input type="date" class="form-control me-2" id="filtroFecha" style="max-width: 200px;">
                <button class="btn btn-primary me-2" onclick="filtrarReporte()">Aplicar Filtro</button>
                <button class="btn btn-secondary" onclick="limpiarFiltro()">Limpiar</button>
            </div>
        </div>
    </div>
    
    <div class="row mb-5">
        <div class="col-md-4">
            <div class="card card-dashboard p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted text-uppercase">Total Recaudado</h6>
                        <h2 class="fw-bold text-success" id="totalDinero">$0</h2>
                    </div>
                    <div class="icon-box"><i class="bi bi-cash-coin"></i></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-dashboard p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted text-uppercase">Entradas Vendidas</h6>
                        <h2 class="fw-bold text-primary" id="totalEntradas">0</h2>
                    </div>
                    <div class="icon-box"><i class="bi bi-ticket-perforated-fill"></i></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-dashboard p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted text-uppercase">Top Película</h6>
                        <h4 class="fw-bold" id="topPelicula">-</h4>
                    </div>
                    <div class="icon-box"><i class="bi bi-trophy-fill text-warning"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="table-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold">Últimas Transacciones</h4>
            <button class="btn btn-danger btn-sm" onclick="borrarDatos()"><i class="bi bi-trash"></i> Resetear Datos</button>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>Fecha Compra</th>
                        <th>Usuario</th>
                        <th>Película</th>
                        <th>Sala / Complejo</th>
                        <th>Función (Fecha / Hora)</th>
                        <th class="text-center">Cant.</th>
                        <th class="text-end">Total</th>
                    </tr>
                </thead>
                <tbody id="tablaVentas"></tbody>
            </table>
        </div>
        <p class="text-center text-muted mt-3" id="mensajeVacio" style="display:none;">Sin ventas registradas.</p>
    </div>
  </div>

  <script>
    const STORAGE_VENTAS = 'moviePop_ventas';
    
    document.addEventListener("DOMContentLoaded", () => {
        // --- VERIFICACIÓN DE ACCESO ---
        const usuario = JSON.parse(localStorage.getItem('usuarioLogueado'));
        
        if (!usuario || usuario.role !== 'admin') {
            alert("Acceso denegado. Solo administradores.");
            window.location.href = "index.html"; 
            return;
        }
        // Si es admin, carga los reportes (sin filtro al inicio)
        cargarReportes();
    });

    function filtrarReporte() {
        const fecha = document.getElementById('filtroFecha').value;
        if (fecha) {
            cargarReportes(fecha);
        } else {
            alert("Por favor, selecciona una fecha para filtrar.");
        }
    }

    function limpiarFiltro() {
        document.getElementById('filtroFecha').value = '';
        cargarReportes(); // Carga sin filtro
    }

    function cargarReportes(filtroFecha = null) {
        const todasLasVentas = JSON.parse(localStorage.getItem(STORAGE_VENTAS)) || [];
        
        // Aplicar Filtro
        const ventasFiltradas = filtroFecha 
            ? todasLasVentas.filter(venta => venta.funcionFecha === filtroFecha)
            : todasLasVentas;

        if(ventasFiltradas.length === 0) {
            document.getElementById('mensajeVacio').style.display = 'block';
            document.getElementById('totalDinero').innerText = "$0";
            document.getElementById('totalEntradas').innerText = "0";
            document.getElementById('topPelicula').innerText = "-";
            document.getElementById('tablaVentas').innerHTML = "";
            return;
        }

        document.getElementById('mensajeVacio').style.display = 'none';

        let dineroTotal = 0;
        let entradasTotales = 0;
        const conteoPeliculas = {};
        const tbody = document.getElementById('tablaVentas');
        tbody.innerHTML = "";

        // Iterar sobre las ventas filtradas
        ventasFiltradas.slice().reverse().forEach(venta => {
            dineroTotal += venta.total;
            entradasTotales += venta.cantidad;
            conteoPeliculas[venta.pelicula] = (conteoPeliculas[venta.pelicula] || 0) + venta.cantidad;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><small>${venta.fechaCompra}</small></td>
                <td class="fw-bold">${venta.usuario}</td>
                <td>${venta.pelicula}</td>
                <td><span class="badge bg-secondary">${venta.complejo}</span> <br> <small class="text-muted">${venta.sala}</small></td>
                <td>${venta.funcionFecha} <br> ${venta.funcionHora} hs</td>
                <td class="text-center fw-bold">${venta.cantidad}</td>
                <td class="text-end fw-bold text-success">$${venta.total.toLocaleString()}</td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('totalDinero').innerText = `$${dineroTotal.toLocaleString()}`;
        document.getElementById('totalEntradas').innerText = entradasTotales;

        let mejorPeli = "N/A";
        let maxVentas = 0;
        for (const [peli, cantidad] of Object.entries(conteoPeliculas)) {
            if (cantidad > maxVentas) {
                maxVentas = cantidad;
                mejorPeli = peli;
            }
        }
        document.getElementById('topPelicula').innerText = mejorPeli;
    }

    function borrarDatos() {
        if(confirm("¿Estás seguro de borrar TODO el historial de ventas? Esta acción es permanente.")) {
            localStorage.removeItem(STORAGE_VENTAS);
            window.location.reload();
        }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>